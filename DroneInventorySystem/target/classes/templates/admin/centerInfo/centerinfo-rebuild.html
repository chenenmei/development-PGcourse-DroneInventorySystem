<!-- 
  注意: このファイルは使用されていません。
  実際のテンプレートは centerinfo.html を参照してください。
  （このファイルは参考用または過去の開発過程の記録として残しています）
-->
<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{layout/template :: layout(~{::title},~{::body/content()})}"
>
  <head>
    <title>InvenTrack</title>
    <!-- Alpine.jsをCDNから読み込み - 安定版を使用 -->定版を使用 -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <style>
      /* ローディング状態の視覚的制御 */
      .spinner-container {
        justify-content: center;
        align-items: center;
        padding: 2rem 0;
      }
      
      /* フォームレイアウト調整 */
      .form-inline label {
        margin-right: 0.5rem;
        margin-bottom: 0;
      }
      
      .form-inline .form-control {
        margin-right: 1rem;
      }
      
      /* デバッグ用スタイル */
      .debug-info {
        margin-top: 10px;
        padding: 8px;
        background-color: #f8f9fc;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        color: #666;
      }
    </style>
  </head>

  <body>
    <!-- 初期データをJSON形式で埋め込む -->
    <script type="text/javascript" th:inline="javascript">
      // 初期データをJavaScriptオブジェクトとして直接埋め込む
      window.initialCenterData = /*[[${centerInfoJson}]]*/ '[]';
      console.log('初期データ埋め込み完了');
    </script>
    
    <div class="card shadow mb-4" 
      x-data="centerInfoComponent()" 
      x-init="init()">

      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">在庫センター情報</h6>
      </div>
  <head>
    <title>InvenTrack</title>
    <!-- Alpine.jsをCDNから読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <style>
      /* ローディング状態の視覚的制御 */
      .spinner-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 2rem 0;
      }
      
      /* フォームレイアウト調整 */
      .form-inline label {
        margin-right: 0.5rem;
        margin-bottom: 0;
      }
      
      .form-inline .form-control {
        margin-right: 1rem;
      }
      
      /* デバッグ用スタイル */
      .debug-info {
        margin-top: 10px;
        padding: 8px;
        background-color: #f8f9fc;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        color: #666;
      }
    </style>
  </head>

  <body>
    <!-- 初期データをJSON形式で埋め込む -->
    <script type="text/javascript" th:inline="javascript">
      // 初期データをJavaScriptオブジェクトとして直接埋め込む
      window.initialCenterData = /*[[${centerInfoJson}]]*/ '[]';
      console.log('初期データ埋め込み完了');
    </script>
    
    <div class="card shadow mb-4" 
      x-data="centerInfoComponent()" 
      x-init="init()">

      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">在庫センター情報</h6>
      </div>

      <div class="card-body">
        <!-- 通知メッセージ (ポップアップ) -->
        <div x-show="notification.show" x-transition x-init="setTimeout(() => notification.show = false, 5000)" 
          class="alert" :class="notification.type === 'success' ? 'alert-success' : 'alert-danger'" role="alert">
          <span x-text="notification.message"></span>
          <button type="button" class="close" @click="notification.show = false">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        
        <!-- 検索フォーム -->
        <div class="search-container mb-3">
          <form id="searchForm" class="form-inline" @submit.prevent="searchCenters">
            <label for="centerName" class="mr-2">検索条件</label>
            
            <label for="centerName" class="mr-2">センター名</label>
            <input type="text" id="centerName" name="centerName" class="form-control mr-2" x-model="searchParams.centerName">
            
            <label for="region" class="mr-2">都道府県</label>
            <select id="region" name="region" class="form-control mr-2" x-model="searchParams.region">
              <option value="">選択してください</option>
              <option th:each="region : ${regions}" 
                th:value="${region.name}" 
                th:text="${region.name}"></option>
            </select>
            
            <!--2025/05/16 機能改修 現在容量範囲が検索できるため、検索項目に「現在容量」のFrom-Toを追加する-->
            <label for="storageCapacityFrom" class="mr-2">現在容量(㎥)</label>
            <input type="text" id="storageCapacityFrom" name="storageCapacityFrom" 
              class="form-control mr-2" maxlength="10" 
              x-model="searchParams.storageCapacityFrom"
              @input="validateCapacityInput($event, 'storageCapacityFrom')"
              :class="{'is-invalid': validationErrors.storageCapacityFrom}">
            <div class="invalid-feedback" x-show="validationErrors.storageCapacityFrom" x-text="validationErrors.storageCapacityFrom"></div>

            <span class="mr-2">～</span>

            <input type="text" id="storageCapacityTo" name="storageCapacityTo" 
              class="form-control mr-2" maxlength="10" 
              x-model="searchParams.storageCapacityTo"
              @input="validateCapacityInput($event, 'storageCapacityTo')"
              :class="{'is-invalid': validationErrors.storageCapacityTo}">
            <div class="invalid-feedback" x-show="validationErrors.storageCapacityTo" x-text="validationErrors.storageCapacityTo"></div>
            
            <div class="invalid-feedback d-block" x-show="validationErrors.fromToComparison" x-text="validationErrors.fromToComparison"></div>
            
            <button type="submit" class="btn btn-primary" :disabled="isSearchButtonDisabled">
              <span x-show="!isLoading">検索</span>
              <span x-show="isLoading" class="spinner-border spinner-border-sm mr-1" role="status" aria-hidden="true"></span>
              <span x-show="isLoading">検索中...</span>
            </button>
          </form>
          
          <!-- エラーメッセージの表示 -->
          <div th:if="${errorMsg}" class="text-danger mt-2">
            <p th:text="${errorMsg}"></p>
          </div>
        </div>
         
        <!-- 在庫センター情報テーブル -->
        <div class="table-responsive">
          <!-- ローディング表示 -->
          <div x-show="isLoading" class="text-center my-3">
            <div class="spinner-border text-primary" role="status">
              <span class="sr-only">Loading...</span>
            </div>
          </div>
          
          <!-- データテーブル -->
          <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0" x-show="!isLoading && !isResultEmpty">
            <thead>
              <tr>
                <th>センター名</th>
                <th>住所</th>
                <th>連絡先</th>
                <th>管理者名</th>
                <th>最大容量(㎥)</th>
                <th>現在容量(㎥)</th>
              </tr>
            </thead>
            <tbody>
              <!-- 表示データ（初期表示または検索結果） -->
              <template x-for="(item, index) in displayData" :key="index">
                <tr>
                  <td x-text="item.centerName || ''"></td>
                  <td x-text="item.address || ''"></td>
                  <td x-text="item.phoneNumber || ''"></td>
                  <td x-text="item.managerName || ''"></td>
                  <td x-text="item.maxStorageCapacity || ''"></td>
                  <td x-text="item.currentStorageCapacity || ''"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        
        <!-- 検索結果がない場合のメッセージ -->
        <div x-show="!isLoading && isResultEmpty" class="alert alert-info mt-3">
          <p class="mb-0">該当するデータはありません。</p>
        </div>
        
        <!-- デバッグ情報 -->
        <div class="debug-info mt-4">
          <h6>システム状態（デバッグ用）:</h6>
          <div><strong>ローディング:</strong> <span x-text="isLoading"></span></div>
          <div><strong>AJAX検索中:</strong> <span x-text="isAjaxSearch"></span></div>
          <div><strong>初期データ件数:</strong> <span x-text="centerInfoList.length"></span></div>
          <div><strong>検索結果件数:</strong> <span x-text="searchResults.length"></span></div>
          <div><strong>表示データ件数:</strong> <span x-text="displayData.length"></span></div>
          <div><strong>結果なしフラグ:</strong> <span x-text="isResultEmpty"></span></div>
        </div>
      </div>
    </div>
  
    <script>
    function centerInfoComponent() {
      return {
        // データ初期化
        searchParams: {
          centerName: '',
          region: '',
          storageCapacityFrom: '',
          storageCapacityTo: ''
        },
        validationErrors: {
          storageCapacityFrom: '',
          storageCapacityTo: '',
          fromToComparison: ''
        },
        isLoading: false,
        isAjaxSearch: false,
        notification: {
          show: false,
          message: '',
          type: 'success'
        },
        centerInfoList: [],
        searchResults: [],
        
        // 初期化処理
        init() {
          console.log('Alpineコンポーネント初期化');
          
          // 初期状態をリセット
          this.isLoading = true;
          this.isAjaxSearch = false;
          this.centerInfoList = [];
          this.searchResults = [];
          
          try {
            console.log('初期データ読み込み試行');
            
            // グローバル変数から初期データを取得
            if (window.initialCenterData) {
              console.log('グローバル変数から初期データ取得');
              
              let parsedData;
              if (typeof window.initialCenterData === 'string') {
                try {
                  parsedData = JSON.parse(window.initialCenterData);
                  console.log('文字列からJSONパース完了');
                } catch (e) {
                  console.error('JSONパースエラー:', e);
                  parsedData = [];
                }
              } else {
                parsedData = window.initialCenterData;
                console.log('既にオブジェクトとして取得');
              }
              
              if (Array.isArray(parsedData)) {
                this.centerInfoList = parsedData;
                console.log('配列データとして処理:', this.centerInfoList.length + '件');
              } else if (parsedData && parsedData.results && Array.isArray(parsedData.results)) {
                this.centerInfoList = parsedData.results;
                console.log('results配列として処理:', this.centerInfoList.length + '件');
              } else {
                console.warn('グローバルデータの形式が不明:', parsedData);
                this.centerInfoList = [];
              }
            } 
            // hidden要素から取得できなかった場合
            else {
              console.log('hidden要素から初期データ取得を試行');
              const initialDataElement = document.getElementById('initialData');
              
              if (!initialDataElement) {
                console.error("initialData要素が見つかりません");
                return;
              }
              
              const jsonData = initialDataElement.value;
              console.log("初期JSONデータ取得:", jsonData ? "データあり" : "データなし");
              
              if (jsonData && jsonData.trim() !== '') {
                // JSONデータをパース
                try {
                  const parsedData = JSON.parse(jsonData);
                  console.log("JSONパース結果:", parsedData);
                  
                  if (Array.isArray(parsedData)) {
                    this.centerInfoList = parsedData;
                  } else if (parsedData && parsedData.results && Array.isArray(parsedData.results)) {
                    this.centerInfoList = parsedData.results;
                  } else {
                    this.centerInfoList = [];
                  }
                  
                  console.log("初期データ読み込み成功:", this.centerInfoList.length + "件");
                } catch (e) {
                  console.error('JSONパースエラー:', e);
                  this.centerInfoList = [];
                }
              } else {
                this.centerInfoList = [];
                console.warn("初期データが空です");
              }
            }
          } catch (error) {
            console.error("初期データの解析エラー:", error);
            this.centerInfoList = [];
            this.notification = {
              show: true,
              message: "データの読み込み中にエラーが発生しました",
              type: "danger"
            };
          } finally {
            // 初期化完了
            this.isLoading = false;
          }
        },
        
        // 表示するデータ（初期表示または検索結果）
        get displayData() {
          return this.isAjaxSearch ? this.searchResults : this.centerInfoList;
        },
        
        // 数値入力のバリデーション
        validateCapacityInput(event, field) {
          const value = event.target.value;
          
          // 数値のみ許可（空白も許可）
          if (value !== '' && !/^\d+$/.test(value)) {
            this.validationErrors[field] = '数値のみ入力可能です';
            return false;
          } else {
            this.validationErrors[field] = '';
          }
          
          // From-To の比較検証
          this.validateFromTo();
          
          return true;
        },
        
        // From-To の比較検証
        validateFromTo() {
          const from = parseInt(this.searchParams.storageCapacityFrom) || 0;
          const to = parseInt(this.searchParams.storageCapacityTo) || 0;
          
          if (this.searchParams.storageCapacityFrom !== '' && 
              this.searchParams.storageCapacityTo !== '' && 
              from > to) {
            this.validationErrors.fromToComparison = '容量(From)は容量(To)以下である必要があります';
            return false;
          } else {
            this.validationErrors.fromToComparison = '';
            return true;
          }
        },
        
        // 検索ボタンの無効化条件
        get isSearchButtonDisabled() {
          return this.validationErrors.storageCapacityFrom || 
                 this.validationErrors.storageCapacityTo || 
                 this.validationErrors.fromToComparison ||
                 this.isLoading;
        },
        
        // 検索結果が空かどうか
        get isResultEmpty() {
          if (this.isAjaxSearch) {
            console.log('AJAX検索モード: 結果数=', this.searchResults.length);
            return !this.searchResults || this.searchResults.length === 0;
          } else {
            console.log('初期表示モード: 結果数=', this.centerInfoList.length);
            return !this.centerInfoList || this.centerInfoList.length === 0;
          }
        },
        
        // 非同期検索処理
        async searchCenters() {
          console.log('検索処理開始');
          
          // バリデーションチェック
          if (this.isSearchButtonDisabled && !this.isLoading) {
            console.log('検索条件が無効: 検索中止');
            return;
          }
          
          // リアルタイムバリデーション
          if (!this.validateFromTo()) {
            console.log('From-Toの検証に失敗: 検索中止');
            return;
          }
          
          // 検索状態を設定
          console.log('検索中フラグ設定: isLoading=true');
          this.isLoading = true;
          this.isAjaxSearch = true;
          this.searchResults = []; // 検索開始時に結果をクリア
          
          try {
            // URL パラメータの作成
            const params = new URLSearchParams({
              centerName: this.searchParams.centerName || '',
              region: this.searchParams.region || '',
              storageCapacityFrom: this.searchParams.storageCapacityFrom || '',
              storageCapacityTo: this.searchParams.storageCapacityTo || ''
            });
            
            // API リクエスト
            console.log('API呼び出し:', `/admin/centerInfo/search?${params.toString()}`);
            const response = await fetch(`/admin/centerInfo/search?${params.toString()}`, {
              method: 'GET',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              },
              credentials: 'same-origin'
            });
            
            // レスポンスデータを解析
            const data = await response.json();
            console.log("API Response:", data); // デバッグ用
            
            // HTTPステータスコードに基づいた処理
            if (response.ok) {
              // 200番台の成功レスポンス
              // ApiResponseDtoの構造に合わせて結果を取得
              console.log('APIレスポンス詳細:', data);
              
              // 様々なレスポンス形式に対応
              if (data.results) {
                // ApiResponseDtoの標準形式
                this.searchResults = data.results;
                console.log('結果を格納(results):', this.searchResults.length + '件');
              } else if (Array.isArray(data)) {
                // 直接配列が返される場合
                this.searchResults = data;
                console.log('結果を格納(array):', this.searchResults.length + '件');
              } else if (data && typeof data === 'object') {
                // その他のオブジェクト形式（プロパティを探索）
                const possibleResultsFields = ['data', 'items', 'content', 'list'];
                let resultsFound = false;
                
                for (const field of possibleResultsFields) {
                  if (data[field] && Array.isArray(data[field])) {
                    this.searchResults = data[field];
                    console.log(`結果を格納(${field}):`, this.searchResults.length + '件');
                    resultsFound = true;
                    break;
                  }
                }
                
                if (!resultsFound) {
                  console.warn('結果フィールドが見つかりませんでした:', data);
                  this.searchResults = [];
                }
              } else {
                this.searchResults = [];
                console.warn('不明なレスポンス形式:', data);
              }
              
              // 成功通知
              this.notification = {
                show: true,
                message: data.message || `検索が完了しました (${this.searchResults.length}件)`,
                type: 'success'
              };
            } else {
              // エラーレスポンス（JSONにエラー情報が含まれている場合）
              let errorMessage = '検索中にエラーが発生しました';
              
              if (data.message) {
                errorMessage = data.message;
              }
              
              // HTTPステータスコードに基づくエラーメッセージの詳細化
              if (response.status >= 400 && response.status < 500) {
                // 400番台：クライアントエラー
                errorMessage = `リクエストエラー: ${errorMessage} (${response.status})`;
                console.error('クライアントエラー:', data);
              } else {
                // 500番台：サーバーエラー
                errorMessage = `サーバーエラー: ${errorMessage} (${response.status})`;
                console.error('サーバーエラー:', data);
              }
              
              throw new Error(errorMessage);
            }
            
          } catch (error) {
            console.error('検索エラー:', error);
            
            // エラーメッセージの取得
            let errorMessage = error.message || '検索中にエラーが発生しました';
            
            // エラー通知
            this.notification = {
              show: true,
              message: errorMessage,
              type: 'danger'
            };
            
            this.searchResults = [];
          } finally {
            console.log('検索処理完了: ローディング状態解除');
            this.isLoading = false;
            
            // 検索結果の状態を確認
            console.log('検索結果状態:', {
              isLoading: this.isLoading,
              isAjaxSearch: this.isAjaxSearch,
              resultCount: this.searchResults.length,
              isEmpty: this.isResultEmpty
            });
          }
        }
      };
    }
    </script>
    
    <!-- 初期データをhidden要素として配置（バックアップ）-->
    <input type="hidden" id="initialData" th:value="${centerInfoJson}">
  </body>
</html>
